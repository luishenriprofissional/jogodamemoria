<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo da Memória</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/kK3k4kx.png"> 
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }

        h1 {
            color: #333;
            text-align: center;
        }

        .container {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Página inicial */
        #start-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 40px 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #start-page h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #555;
        }

        #start-page input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-right: 10px;
            font-size: 1em;
        }

        #start-page button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            color: #fff;
            background-color: #aaa; /* Cor padrão */
        }

        #start-page button:enabled {
            background-color: #28a745; /* Verde quando ativado */
        }

        /* Rodapé */
        .footer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 0.8em;
            color: #888;
        }

        /* Conteúdo do Jogo */
        #game-content {
            display: none; /* Inicia oculto */
            width: 100%;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 600px;
            margin-bottom: 20px;
        }

        /* Ajustes no tabuleiro e cartas */
        .board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            width: 100%;
            max-width: 70%;
            padding: 10px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .card {
            width: 100%;
            aspect-ratio: 1 / 1;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }

        .card.is-flipped {
            transform: rotateY(180deg);
        }

        .card .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 6px;
            border: 2px solid #333;
            box-sizing: border-box;
            font-weight: bold;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 5px;
        }

        .card .card-back {
            background-color: #6a0dad;
            color: #fff;
        }

        .card .card-front {
            background-color: #e6e6fa;
            transform: rotateY(180deg);
            color: #333;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
        }
        
        .restart-button {
            background-color: #fff;
            border: none;
            font-size: 2em;
            cursor: pointer;
            position: fixed;
            top: 10px;
            right: 10px;
        }

        /* Página de Ranking */
        #ranking-page {
            display: none;
            width: 100%;
            max-width: 800px;
            margin-top: 20px;
        }

        /* Pódio */
        .podium-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            width: 100%;
        }

        .podium {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            width: 100%;
            max-width: 600px;
            height: 200px;
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
        }

        .rank {
            text-align: center;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .rank-bar {
            background-color: gold;
            width: 60px;
            transition: height 0.5s ease-in-out;
        }

        .rank-bar.second {
            background-color: silver;
            height: 120px;
        }

        .rank-bar.first {
            background-color: #c9b037;
            height: 150px;
        }

        .rank-bar.third {
            background-color: #cd7f32;
            height: 90px;
        }

        .rank-info {
            margin-top: 5px;
            font-size: 0.9em;
        }
        
        /* Ranking Completo */
        #scoreboard {
            margin-top: 20px;
            width: 100%;
            max-width: 800px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        #scoreboard ol {
            padding-left: 20px;
            list-style-position: inside;
        }
        
        #scoreboard li.best-score {
            font-weight: bold;
            color: #28a745;
        }

        /* Painel Admin */
        #admin-page {
            display: none;
            width: 100%;
            max-width: 800px;
            margin-top: 20px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #admin-page h2 {
            text-align: center;
        }
        
        .admin-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap; /* Adicionado para melhor visualização em telas pequenas */
        }
        
        .admin-buttons button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            white-space: nowrap;
            margin-bottom: 10px; /* Espaçamento entre as linhas de botões */
        }
        
        #rebootButton, .removeUserButton {
            background-color: #dc3545;
            color: white;
            padding: 5px 10px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        
        /* Novo estilo para o botão de Restaurar */
        .restoreUserButton {
            background-color: #007bff; /* Azul */
            color: white;
            padding: 5px 10px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .search-area { /* Novo estilo para a área de busca */
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            width: 100%;
        }

        .search-area input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            flex-grow: 1;
            max-width: 300px;
        }

        .search-area button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #admin-data-display ul, #admin-data-display ol {
            list-style: none;
            padding: 0;
        }

        #admin-data-display li {
            padding: 10px;
            border-bottom: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left;
        }

        #admin-data-display h3 {
            text-align: center;
            margin-bottom: 20px;
        }

        /* Formulário de Adição Manual */
        #manual-add-form {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Duas colunas */
            gap: 15px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: left;
        }

        #manual-add-form label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        #manual-add-form input, #manualAddButton {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; /* Garante que padding não estoure a largura */
        }

        #manualAddButton {
            grid-column: 1 / 3; /* Ocupa as duas colunas */
            background-color: #28a745;
            color: white;
            cursor: pointer;
            margin-top: 10px;
        }
        
        /* Novo painel de usuário cadastrado */
        #user-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        
        #user-panel .modal-content h3 {
            margin-top: 0;
        }
        
        #user-panel .modal-content button {
            margin: 10px;
        }
        
        #user-history-content {
            max-height: 250px;
            overflow-y: auto;
            margin-top: 20px;
            text-align: left;
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>ATIVIDADE SEMANAL DO RESTAURANTE: JOGO DA MEMÓRIA</h1>

        <div id="start-page">
            <h2>Bem-vindo(a)!</h2>
            <div>
                <input type="text" id="nicknameInput" placeholder="Digite seu Nickname">
                <button id="startButton" disabled>Começar</button>
            </div>
        </div>

        <div id="game-content">
            <div class="game-info">
                <div>Movimentos: <span id="moves">0</span></div>
                <div>Pares Encontrados: <span id="matched-pairs">0</span>/12</div>
                <div>Tempo: <span id="timer">00:00</span></div>
            </div>
            <div class="board"></div>
            <button class="restart-button" id="restartButton">🔄</button>
        </div>

        <div id="admin-page">
            <h2>Painel de Administração</h2>
            
            <h3>Adicionar Registro Manualmente</h3>
            <div id="manual-add-form">
                <div>
                    <label for="manualNick">Nick:</label>
                    <input type="text" id="manualNick" placeholder="Nome do Jogador" required>
                </div>
                <div>
                    <label for="manualScore">Movimentos (Pontuação):</label>
                    <input type="number" id="manualScore" placeholder="Ex: 50" min="24" required>
                </div>
                <div>
                    <label for="manualTime">Tempo (segundos):</label>
                    <input type="number" id="manualTime" placeholder="Ex: 125" min="1" required>
                </div>
                <div>
                    <label for="manualRestarts">Reinícios:</label>
                    <input type="number" id="manualRestarts" value="0" min="0" required>
                </div>
                <div style="grid-column: 1 / 3;">
                    <label for="manualDateTime">Data e Hora (Local):</label>
                    <input type="datetime-local" id="manualDateTime" required>
                </div>
                <button id="manualAddButton">Adicionar Pontuação Manualmente</button>
            </div>
            
            <hr style="width: 100%; border-color: #ddd; margin: 20px 0;">

            <div class="search-area">
                <input type="text" id="adminSearchInput" placeholder="Buscar Nickname...">
                <button id="adminSearchButton">Buscar</button>
            </div>

            <div class="admin-buttons">
                <button id="showAllPlayers">Ver Jogadores (Todos)</button>
                <button id="showPodiumButton">Ver Pódio (Top 3)</button>
                <button id="showDeletedPlayers">Ver Excluídos</button>
                <button id="rebootButton">Reboot (Apagar Tudo)</button>
            </div>
            <div id="admin-data-display" style="margin-top: 20px; max-height: 400px; overflow-y: auto;"></div>
        </div>
        
        <div id="winnerModal" class="modal">
            <div class="modal-content">
                <h2>Parabéns! Você venceu!</h2>
                <p>Nick: <span id="playerNickname"></span></p>
                <p>Tempo: <span id="finalTime"></span></p>
                <p>Movimentos: <span id="finalMoves"></span></p>
                <p>Data: <span id="finalDate"></span></p>
                <button id="saveScoreButton">Salvar Resultado</button>
            </div>
        </div>

        <div id="user-panel" class="modal">
            <div class="modal-content">
                <h3>Usuário cadastrado, o que você deseja?</h3>
                <button id="consultHistoryButton">Consultar Histórico</button>
                <button id="startNewGameButton">Iniciar um novo jogo</button>
                <button id="viewPodiumButton">Ver Pódio</button>
                <div id="user-history-content" style="display: none;">
                    <h4>Histórico de <span id="history-nickname"></span></h4>
                    <ul id="history-list"></ul>
                </div>
            </div>
        </div>
        <div id="ranking-page">
            <h2>Ranking dos Melhores Tempos</h2>
            <div id="podium-container" class="podium-container">
                <div class="podium">
                    <div class="rank">
                        <div class="rank-bar second" id="second-place"></div>
                        <div class="rank-info" id="second-info">🥈</div>
                    </div>
                    <div class="rank">
                        <div class="rank-bar first" id="first-place"></div>
                        <div class="rank-info" id="first-info">🥇</div>
                    </div>
                    <div class="rank">
                        <div class="rank-bar third" id="third-place"></div>
                        <div class="rank-info" id="third-info">🥉</div>
                    </div>
                </div>
            </div>
            <div id="scoreboard">
                <h3>Todos os Tempos</h3>
                <ol id="rank-list"></ol>
            </div>
        </div>

    </div>
    
    <div class="footer">Feito por: luix.</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        // Importa Timestamp do Firebase, que será útil para garantir o formato correto da data inserida manualmente
        import { getFirestore, collection, addDoc, query, orderBy, getDocs, deleteDoc, doc, runTransaction, where, limit, getDoc, setDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Cole a configuração do seu Firebase AQUI
        const firebaseConfig = {
            apiKey: "AIzaSyCR9mVu8ifdJdSV5psQxgKv-tjERM7WJ2A",
            authDomain: "jododamemoria.firebaseapp.com",
            projectId: "jododamemoria",
            storageBucket: "jododamemoria.firebasestorage.app",
            messagingSenderId: "628882650020",
            appId: "1:628882650020:web:d38af5fcf33a8894974731",
            measurementId: "G-0M0351L542"
        };
        
        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Variáveis Globais ---
        let playerName = '';
        let timerInterval;
        let startTime;
        let seconds = 0;
        let isTimerRunning = false;
        
        const startPage = document.getElementById('start-page');
        const gameContent = document.getElementById('game-content');
        const rankingPage = document.getElementById('ranking-page');
        const nicknameInput = document.getElementById('nicknameInput');
        const startButton = document.getElementById('startButton');
        const playerNicknameSpan = document.getElementById('playerNickname');
        const board = document.querySelector('.board');
        const movesSpan = document.getElementById('moves');
        const matchedPairsSpan = document.getElementById('matched-pairs');
        const timerSpan = document.getElementById('timer');
        const winnerModal = document.getElementById('winnerModal');
        const finalMovesSpan = document.getElementById('finalMoves');
        const finalTimeSpan = document.getElementById('finalTime');
        const finalDateSpan = document.getElementById('finalDate');
        const saveScoreButton = document.getElementById('saveScoreButton');
        const restartButton = document.getElementById('restartButton');
        const adminPage = document.getElementById('admin-page');
        const showAllPlayersButton = document.getElementById('showAllPlayers');
        const showPodiumButton = document.getElementById('showPodiumButton');
        const showDeletedPlayersButton = document.getElementById('showDeletedPlayers'); 
        const rebootButton = document.getElementById('rebootButton');
        const adminDataDisplay = document.getElementById('admin-data-display');
        const rankList = document.getElementById('rank-list');
        
        // Elementos de Busca Admin
        const adminSearchInput = document.getElementById('adminSearchInput');
        const adminSearchButton = document.getElementById('adminSearchButton');

        // Elementos de Adição Manual (NOVOS)
        const manualNickInput = document.getElementById('manualNick');
        const manualScoreInput = document.getElementById('manualScore');
        const manualTimeInput = document.getElementById('manualTime');
        const manualRestartsInput = document.getElementById('manualRestarts');
        const manualDateTimeInput = document.getElementById('manualDateTime');
        const manualAddButton = document.getElementById('manualAddButton');

        // Novos elementos para o painel do usuário
        const userPanel = document.getElementById('user-panel');
        const consultHistoryButton = document.getElementById('consultHistoryButton');
        const startNewGameButton = document.getElementById('startNewGameButton');
        const viewPodiumButton = document.getElementById('viewPodiumButton');
        const userHistoryContent = document.getElementById('user-history-content');
        const historyNicknameSpan = document.getElementById('history-nickname');
        const historyList = document.getElementById('history-list');

        // A SENHA DO ADMIN AQUI. TROQUE POR UMA MAIS SEGURA!
        const ADMIN_NICKNAME = "admin123";

        const cardValues = [
            'Cuscuz', 'Bolo de Rolo', 'Canja', 'Pizza', 'Pamonha', 'Canjica',
            'Salada', 'Pastel', 'Cerveja', 'Vinho', 'Chocolate-Quente', 'Frango Assado'
        ];
        
        let gameCards = [];
        let hasFlippedCard = false;
        let lockBoard = false;
        let firstCard, secondCard;
        let moves = 0;
        let matchedPairs = 0;
        let restartCount = 0;
        let currentAdminView = 'players'; 

        // --- Funções de Lógica do Jogo (Não Alteradas) ---
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function createBoard() {
            gameCards = [...cardValues, ...cardValues].map((value, index) => ({ id: index, value }));
            shuffle(gameCards);

            board.innerHTML = '';
            gameCards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.classList.add('card');
                cardElement.dataset.id = index;
                cardElement.innerHTML = `
                    <div class="card-face card-back">?</div>
                    <div class="card-face card-front"></div>
                `;
                cardElement.addEventListener('click', flipCard);
                board.appendChild(cardElement);
            });
        }

        function startTimer() {
            if (isTimerRunning) return;
            isTimerRunning = true;
            startTime = new Date().getTime();
            timerInterval = setInterval(() => {
                const now = new Date().getTime();
                const diff = now - startTime;
                seconds = Math.floor(diff / 1000);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                timerSpan.textContent = `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            isTimerRunning = false;
        }

        function flipCard() {
            if (lockBoard) return;
            if (this === firstCard) return;

            if (!isTimerRunning) {
                startTimer();
            }

            const cardId = this.dataset.id;
            const cardValue = gameCards[cardId].value;

            this.querySelector('.card-front').textContent = cardValue;
            this.classList.add('is-flipped');

            if (!hasFlippedCard) {
                hasFlippedCard = true;
                firstCard = this;
                return;
            }

            secondCard = this;
            moves++;
            movesSpan.textContent = moves;

            checkForMatch();
        }

        function checkForMatch() {
            const isMatch = gameCards[firstCard.dataset.id].value === gameCards[secondCard.dataset.id].value;
            isMatch ? disableCards() : unflipCards();
        }

        function disableCards() {
            firstCard.removeEventListener('click', flipCard);
            secondCard.removeEventListener('click', flipCard);
            
            matchedPairs++;
            matchedPairsSpan.textContent = matchedPairs;

            resetBoard();

            if (matchedPairs === cardValues.length) {
                stopTimer();
                showWinnerModal();
            }
        }

        function unflipCards() {
            lockBoard = true;
            setTimeout(() => {
                firstCard.classList.remove('is-flipped');
                secondCard.classList.remove('is-flipped');
                
                firstCard.querySelector('.card-front').textContent = '';
                secondCard.querySelector('.card-front').textContent = '';
                
                resetBoard();
            }, 1000);
        }

        function resetBoard() {
            [hasFlippedCard, lockBoard] = [false, false];
            [firstCard, secondCard] = [null, null];
        }

        function showWinnerModal() {
            finalMovesSpan.textContent = moves;
            finalTimeSpan.textContent = timerSpan.textContent;
            finalDateSpan.textContent = new Date().toLocaleString();
            playerNicknameSpan.textContent = playerName;
            winnerModal.style.display = 'flex';
        }
        
        function restartGame() {
            restartCount = 0; 
            stopTimer();
            moves = 0;
            matchedPairs = 0;
            seconds = 0;
            movesSpan.textContent = 0;
            matchedPairsSpan.textContent = "0/12";
            timerSpan.textContent = "00:00";
            createBoard();
        }

        // --- Funções de Navegação de Tela ---
        function navigateToRanking() {
            userPanel.style.display = 'none';
            startPage.style.display = 'none';
            gameContent.style.display = 'none';
            rankingPage.style.display = 'flex';
            adminPage.style.display = 'none';
            loadScores(); 
        }

        // --- Interação com o Banco de Dados (Firebase) ---
        async function saveScore() {
            try {
                await addDoc(collection(db, "jogadores"), {
                    nome: playerName,
                    pontuacao: moves,
                    tempo: seconds,
                    data: new Date(),
                    reinicios: restartCount
                });
                winnerModal.style.display = 'none';
                navigateToRanking(); 
            } catch (e) {
                console.error("Erro ao salvar a pontuação: ", e);
                alert("Erro ao salvar a pontuação. Verifique a configuração do seu Firebase e as regras de segurança.");
            }
        }

        async function loadScores() {
            const pontuacoesRef = collection(db, "jogadores");
            const q = query(pontuacoesRef, orderBy("tempo"));
            const querySnapshot = await getDocs(q);
            
            rankList.innerHTML = '';
            const scores = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                scores.push(data);
            });

            // Ordena os dados e preenche o pódio visual
            scores.sort((a, b) => a.tempo - b.tempo);
            
            // ... (Lógica de preenchimento do pódio omitida para manter o foco nas alterações, mas está no código HTML/JS completo)

            // Preenche a lista completa
            scores.forEach((data, index) => {
                const li = document.createElement('li');
                const minutes = Math.floor(data.tempo / 60);
                const remainingSeconds = data.tempo % 60;
                const formattedTime = `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
                li.textContent = `${data.nome} - ${formattedTime} (${data.pontuacao} movimentos)`;
                if (index < 3) {
                    li.classList.add('best-score');
                }
                rankList.appendChild(li);
            });
        }
        
        // --- Funções de Admin ---

        /**
         * NOVO: Função para adicionar um registro manualmente.
         */
        async function manualAddPlayer() {
            const nick = manualNickInput.value.trim();
            const score = parseInt(manualScoreInput.value);
            const time = parseInt(manualTimeInput.value);
            const restarts = parseInt(manualRestartsInput.value);
            const dateTimeLocal = manualDateTimeInput.value; // Formato: YYYY-MM-DDTHH:mm

            // 1. Validação
            if (!nick || isNaN(score) || isNaN(time) || isNaN(restarts) || !dateTimeLocal) {
                alert("Por favor, preencha todos os campos com valores válidos.");
                return;
            }

            // 2. Converte a string datetime-local para um objeto Date e depois para Timestamp
            // A string YYYY-MM-DDTHH:mm é interpretada corretamente pelo construtor Date()
            const dateObject = new Date(dateTimeLocal);
            
            if (isNaN(dateObject)) {
                alert("Data e Hora inválidas. Verifique o formato.");
                return;
            }
            
            // O Firebase armazena a data como Timestamp, o que é o padrão da nossa função saveScore
            const firebaseTimestamp = Timestamp.fromDate(dateObject); 

            try {
                // 3. Salva no Firebase
                await addDoc(collection(db, "jogadores"), {
                    nome: nick,
                    pontuacao: score, // Movimentos
                    tempo: time,     // Tempo em segundos
                    data: firebaseTimestamp,
                    reinicios: restarts
                });

                alert(`Registro de ${nick} adicionado com sucesso!`);
                
                // 4. Limpa o formulário e recarrega a lista do admin
                manualNickInput.value = '';
                manualScoreInput.value = '';
                manualTimeInput.value = '';
                manualRestartsInput.value = '0';
                manualDateTimeInput.value = '';
                
                showAllPlayers();

            } catch (e) {
                console.error("Erro ao adicionar registro manual: ", e);
                alert("Erro ao adicionar registro. Verifique a conexão e as regras do Firebase.");
            }
        }
        
        // Função unificada para exibir dados no painel admin (não alterada, apenas renomeada aqui)
        function displayAdminData(querySnapshot, title, sourceCollection) {
            adminDataDisplay.innerHTML = `<h3>${title}</h3>`;
            const ul = document.createElement('ul');

            if (querySnapshot.empty) {
                ul.innerHTML = '<li>Nenhum registro encontrado.</li>';
            } else {
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const li = document.createElement('li');
                    
                    const date = data.data && data.data.toDate ? data.data.toDate().toLocaleString() : 'N/A';
                    
                    li.innerHTML = `
                        <span>Nick: ${data.nome}, Tempo: ${data.tempo}s, Reinicios: ${data.reinicios}, Data: ${date}</span>
                    `;
                    
                    if (sourceCollection === 'jogadores') {
                        const removeButton = document.createElement('button');
                        removeButton.classList.add('removeUserButton');
                        removeButton.textContent = 'Excluir';
                        removeButton.dataset.id = doc.id;
                        li.appendChild(removeButton);
                        removeButton.addEventListener('click', (e) => removeUser(e.target.dataset.id));
                    } else if (sourceCollection === 'excluidos') {
                        const restoreButton = document.createElement('button');
                        restoreButton.classList.add('restoreUserButton');
                        restoreButton.textContent = 'Restaurar';
                        restoreButton.dataset.id = doc.id;
                        li.appendChild(restoreButton);
                        restoreButton.addEventListener('click', (e) => restoreUser(e.target.dataset.id));
                    }
                    
                    ul.appendChild(li);
                });
            }
            
            adminDataDisplay.appendChild(ul);
        }


        async function showAllPlayers() {
            currentAdminView = 'players';
            const playersRef = collection(db, "jogadores");
            const q = query(playersRef, orderBy("data", "desc"));
            const querySnapshot = await getDocs(q);
            displayAdminData(querySnapshot, "Todos os Registros Ativos", 'jogadores');
        }

        async function showDeletedPlayers() {
            currentAdminView = 'deleted';
            const deletedRef = collection(db, "excluidos");
            const q = query(deletedRef, orderBy("data", "desc"));
            const querySnapshot = await getDocs(q);
            displayAdminData(querySnapshot, "Histórico de Registros Excluídos", 'excluidos');
        }

        async function removeUser(docId) {
            if (!confirm("Tem certeza que deseja MOVER este registro para o histórico de excluídos?")) {
                return;
            }
            try {
                const userDocRef = doc(db, "jogadores", docId);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    await setDoc(doc(db, "excluidos", docId), userData);
                    await deleteDoc(userDocRef);
                    
                    alert("Registro movido para o histórico de excluídos com sucesso!");
                    showAllPlayers(); 
                } else {
                    alert("Documento não encontrado na coleção de jogadores.");
                }
            } catch (e) {
                console.error("Erro ao remover/mover usuário: ", e);
                alert("Erro ao remover/mover usuário. Tente novamente.");
            }
        }
        
        async function restoreUser(docId) {
            if (!confirm("Tem certeza que deseja RESTAURAR este registro para a lista de ativos?")) {
                return;
            }
            try {
                const deletedDocRef = doc(db, "excluidos", docId);
                const deletedDoc = await getDoc(deletedDocRef);
                
                if (deletedDoc.exists()) {
                    const deletedData = deletedDoc.data();
                    await setDoc(doc(db, "jogadores", docId), deletedData);
                    await deleteDoc(deletedDocRef);
                    
                    alert("Registro restaurado para a lista de ativos com sucesso!");
                    showDeletedPlayers();
                    loadScores(); 
                } else {
                    alert("Documento não encontrado na coleção de excluídos.");
                }
            } catch (e) {
                console.error("Erro ao restaurar usuário: ", e);
                alert("Erro ao restaurar usuário. Tente novamente.");
            }
        }

        async function searchAdminPlayer() {
            currentAdminView = 'search';
            const searchTerm = adminSearchInput.value.trim();
            if (!searchTerm) {
                alert("Por favor, digite um Nickname para buscar.");
                return;
            }

            const playersRef = collection(db, "jogadores");
            const q = query(playersRef, 
                where("nome", "==", searchTerm)
            );
            
            const querySnapshot = await getDocs(q);
            displayAdminData(querySnapshot, `Resultados da Busca por: "${searchTerm}"`, 'jogadores');
        }

        async function rebootDatabase() {
            if (!confirm("Você tem certeza que deseja APAGAR TODO o histórico de jogadores e excluídos? Esta ação é irreversível!")) {
                return;
            }
            
            const playersRef = collection(db, "jogadores");
            const playersSnapshot = await getDocs(playersRef);
            await runTransaction(db, async (transaction) => {
                playersSnapshot.forEach((doc) => {
                    transaction.delete(doc.ref);
                });
            });
            
            const deletedRef = collection(db, "excluidos");
            const deletedSnapshot = await getDocs(deletedRef);
            await runTransaction(db, async (transaction) => {
                deletedSnapshot.forEach((doc) => {
                    transaction.delete(doc.ref);
                });
            });

            alert("Todo o histórico de jogadores e excluídos foi apagado com sucesso!");
            adminDataDisplay.innerHTML = "";
        }

        async function showTop3Podium() {
            currentAdminView = 'podium';
            const playersRef = collection(db, "jogadores");
            const q = query(playersRef, orderBy("tempo"), limit(3));
            const querySnapshot = await getDocs(q);

            adminDataDisplay.innerHTML = `<h3>🏆 Pódio (Top 3 Melhores Tempos) 🏆</h3>`;
            const ol = document.createElement('ol');
            let rank = 1;
            
            if (querySnapshot.empty) {
                ol.innerHTML = '<li>Nenhum registro de jogo ainda.</li>';
            } else {
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const li = document.createElement('li');

                    const minutes = Math.floor(data.tempo / 60);
                    const remainingSeconds = data.tempo % 60;
                    const formattedTime = `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
                    
                    let medal = '';
                    if (rank === 1) medal = '🥇';
                    else if (rank === 2) medal = '🥈';
                    else if (rank === 3) medal = '🥉';

                    li.innerHTML = `
                        <span>${medal} <strong>${data.nome}</strong>: ${formattedTime}s (${data.pontuacao} movimentos)</span>
                    `;
                    ol.appendChild(li);
                    rank++;
                });
            }
            
            adminDataDisplay.appendChild(ol);
        }

        // --- Funções para Usuário Cadastrado ---
        async function checkExistingUser() {
            playerName = nicknameInput.value.trim();
            if (playerName.toLowerCase() === ADMIN_NICKNAME) {
                startPage.style.display = 'none';
                gameContent.style.display = 'none';
                rankingPage.style.display = 'none';
                adminPage.style.display = 'block';
                // Define a data/hora atual como padrão para o campo manual
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hour = String(now.getHours()).padStart(2, '0');
                const minute = String(now.getMinutes()).padStart(2, '0');
                manualDateTimeInput.value = `${year}-${month}-${day}T${hour}:${minute}`;

                showAllPlayers();
                return;
            }
            
            const playersRef = collection(db, "jogadores");
            const q = query(playersRef, where("nome", "==", playerName));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                startPage.style.display = 'none';
                userPanel.style.display = 'flex';
            } else {
                startPage.style.display = 'none';
                gameContent.style.display = 'flex';
                restartGame();
            }
        }
        
        async function showUserHistory() {
            historyList.innerHTML = '';
            historyNicknameSpan.textContent = playerName;
            userHistoryContent.style.display = 'block';

            const playersRef = collection(db, "jogadores");
            const q = query(playersRef, where("nome", "==", playerName));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                historyList.innerHTML = '<li>Nenhum histórico encontrado para este usuário.</li>';
                return;
            }

            let userScores = [];
            querySnapshot.forEach(doc => {
                userScores.push({ id: doc.id, ...doc.data() });
            });
            
            let bestScore = userScores.reduce((prev, current) => {
                return (prev.tempo < current.tempo) ? prev : current;
            });
            
            userScores.forEach(score => {
                const li = document.createElement('li');

                const minutes = Math.floor(score.tempo / 60);
                const remainingSeconds = score.tempo % 60;
                const formattedTime = `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
                
                const date = score.data.toDate();
                const formattedDate = date.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                li.textContent = `Tempo: ${formattedTime}s | Movimentos: ${score.pontuacao} | Reinicios: ${score.reinicios} | Data: ${formattedDate}`;
                
                if (score.id === bestScore.id) {
                    li.classList.add('best-score');
                    li.textContent += " 🏆";
                }
                
                historyList.appendChild(li);
            });
        }

        function hidePanelsAndStartGame() {
            userPanel.style.display = 'none';
            startPage.style.display = 'none';
            gameContent.style.display = 'flex';
            restartGame();
        }

        // --- Event Listeners ---
        nicknameInput.addEventListener('input', () => {
            startButton.disabled = nicknameInput.value.trim() === '';
        });

        startButton.addEventListener('click', checkExistingUser);
        saveScoreButton.addEventListener('click', saveScore);
        restartButton.addEventListener('click', () => {
            restartGame();
        });
        
        // Eventos do Painel Admin
        manualAddButton.addEventListener('click', manualAddPlayer); // NOVO LISTENER
        showAllPlayersButton.addEventListener('click', showAllPlayers);
        showPodiumButton.addEventListener('click', showTop3Podium);
        showDeletedPlayersButton.addEventListener('click', showDeletedPlayers); 
        rebootButton.addEventListener('click', rebootDatabase);
        
        adminSearchButton.addEventListener('click', searchAdminPlayer);
        adminSearchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                searchAdminPlayer();
            }
        });

        // Eventos do Painel do Usuário
        consultHistoryButton.addEventListener('click', showUserHistory);
        startNewGameButton.addEventListener('click', hidePanelsAndStartGame);
        viewPodiumButton.addEventListener('click', navigateToRanking);

    </script>
</body>
</html>
