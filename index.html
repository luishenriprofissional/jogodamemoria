<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo da Mem√≥ria</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/kK3k4kx.png"> 
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }

        h1 {
            color: #333;
            text-align: center;
        }

        .container {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* P√°gina inicial */
        #start-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 40px 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #start-page h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #555;
        }

        #start-page input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-right: 10px;
            font-size: 1em;
        }

        #start-page button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            color: #fff;
            background-color: #aaa; /* Cor padr√£o */
        }

        #start-page button:enabled {
            background-color: #28a745; /* Verde quando ativado */
        }

        /* Rodap√© */
        .footer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 0.8em;
            color: #888;
        }

        /* Conte√∫do do Jogo */
        #game-content {
            display: none; /* Inicia oculto */
            width: 100%;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 600px;
            margin-bottom: 20px;
        }

        /* Ajustes no tabuleiro e cartas */
        .board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            width: 100%;
            max-width: 70%;
            padding: 10px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .card {
            width: 100%;
            aspect-ratio: 1 / 1;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }

        .card.is-flipped {
            transform: rotateY(180deg);
        }

        .card .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 6px;
            border: 2px solid #333;
            box-sizing: border-box;
            font-weight: bold;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 5px;
        }

        .card .card-back {
            background-color: #6a0dad;
            color: #fff;
        }

        .card .card-front {
            background-color: #e6e6fa;
            transform: rotateY(180deg);
            color: #333;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
        }
        
        .restart-button {
            background-color: #fff;
            border: none;
            font-size: 2em;
            cursor: pointer;
            position: fixed;
            top: 10px;
            right: 10px;
        }

        /* P√°gina de Ranking */
        #ranking-page {
            display: none;
            width: 100%;
            max-width: 800px;
            margin-top: 20px;
        }

        /* P√≥dio */
        .podium-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            width: 100%;
        }

        .podium {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            width: 100%;
            max-width: 600px;
            height: 200px;
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
        }

        .rank {
            text-align: center;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .rank-bar {
            background-color: gold;
            width: 60px;
            transition: height 0.5s ease-in-out;
        }

        .rank-bar.second {
            background-color: silver;
            height: 120px;
        }

        .rank-bar.first {
            background-color: #c9b037;
            height: 150px;
        }

        .rank-bar.third {
            background-color: #cd7f32;
            height: 90px;
        }

        .rank-info {
            margin-top: 5px;
            font-size: 0.9em;
        }
        
        /* Ranking Completo */
        #scoreboard {
            margin-top: 20px;
            width: 100%;
            max-width: 800px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        #scoreboard ol {
            padding-left: 20px;
            list-style-position: inside;
        }
        
        #scoreboard li.best-score {
            font-weight: bold;
            color: #28a745;
        }

        /* Painel Admin */
        #admin-page {
            display: none;
            width: 100%;
            max-width: 800px;
            margin-top: 20px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #admin-page h2 {
            text-align: center;
        }
        
        .admin-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap; /* Adicionado para melhor visualiza√ß√£o em telas pequenas */
        }
        
        .admin-buttons button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        #rebootButton, .removeUserButton {
            background-color: #dc3545;
            color: white;
            padding: 5px 10px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        
        .search-area { /* Novo estilo para a √°rea de busca */
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            width: 100%;
        }

        .search-area input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            flex-grow: 1;
            max-width: 300px;
        }

        .search-area button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #admin-data-display ul, #admin-data-display ol {
            list-style: none;
            padding: 0;
        }

        #admin-data-display li {
            padding: 10px;
            border-bottom: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left;
        }

        #admin-data-display h3 {
            text-align: center;
            margin-bottom: 20px;
        }
        /* Novo painel de usu√°rio cadastrado */
        #user-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        
        #user-panel .modal-content h3 {
            margin-top: 0;
        }
        
        #user-panel .modal-content button {
            margin: 10px;
        }
        
        #user-history-content {
            max-height: 250px;
            overflow-y: auto;
            margin-top: 20px;
            text-align: left;
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>ATIVIDADE SEMANAL DO RESTAURANTE: JOGO DA MEM√ìRIA</h1>

        <div id="start-page">
            <h2>Bem-vindo(a)!</h2>
            <div>
                <input type="text" id="nicknameInput" placeholder="Digite seu Nickname">
                <button id="startButton" disabled>Come√ßar</button>
            </div>
        </div>

        <div id="game-content">
            <div class="game-info">
                <div>Movimentos: <span id="moves">0</span></div>
                <div>Pares Encontrados: <span id="matched-pairs">0</span>/12</div>
                <div>Tempo: <span id="timer">00:00</span></div>
            </div>
            <div class="board"></div>
            <button class="restart-button" id="restartButton">üîÑ</button>
        </div>

        <div id="admin-page">
            <h2>Painel de Administra√ß√£o</h2>
            
            <div class="search-area">
                <input type="text" id="adminSearchInput" placeholder="Buscar Nickname...">
                <button id="adminSearchButton">Buscar</button>
            </div>

            <div class="admin-buttons">
                <button id="showAllPlayers">Ver Jogadores (Todos)</button>
                <button id="showPodiumButton">Ver P√≥dio (Top 3)</button>
                <button id="rebootButton">Reboot (Apagar Tudo)</button>
            </div>
            <div id="admin-data-display" style="margin-top: 20px; max-height: 400px; overflow-y: auto;"></div>
        </div>
        
        <div id="winnerModal" class="modal">
            <div class="modal-content">
                <h2>Parab√©ns! Voc√™ venceu!</h2>
                <p>Nick: <span id="playerNickname"></span></p>
                <p>Tempo: <span id="finalTime"></span></p>
                <p>Movimentos: <span id="finalMoves"></span></p>
                <p>Data: <span id="finalDate"></span></p>
                <button id="saveScoreButton">Salvar Resultado</button>
            </div>
        </div>

        <div id="user-panel" class="modal">
            <div class="modal-content">
                <h3>Usu√°rio cadastrado, o que voc√™ deseja?</h3>
                <button id="consultHistoryButton">Consultar Hist√≥rico</button>
                <button id="startNewGameButton">Iniciar um novo jogo</button>
                <button id="viewPodiumButton">Ver P√≥dio</button> <div id="user-history-content" style="display: none;">
                    <h4>Hist√≥rico de <span id="history-nickname"></span></h4>
                    <ul id="history-list"></ul>
                </div>
            </div>
        </div>
        <div id="ranking-page">
            <h2>Ranking dos Melhores Tempos</h2>
            <div id="podium-container" class="podium-container">
                <div class="podium">
                    <div class="rank">
                        <div class="rank-bar second" id="second-place"></div>
                        <div class="rank-info" id="second-info">ü•à</div>
                    </div>
                    <div class="rank">
                        <div class="rank-bar first" id="first-place"></div>
                        <div class="rank-info" id="first-info">ü•á</div>
                    </div>
                    <div class="rank">
                        <div class="rank-bar third" id="third-place"></div>
                        <div class="rank-info" id="third-info">ü•â</div>
                    </div>
                </div>
            </div>
            <div id="scoreboard">
                <h3>Todos os Tempos</h3>
                <ol id="rank-list"></ol>
            </div>
        </div>

    </div>
    
    <div class="footer">Feito por: luix.</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, getDocs, deleteDoc, doc, runTransaction, where, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Cole a configura√ß√£o do seu Firebase AQUI
        const firebaseConfig = {
            apiKey: "AIzaSyCR9mVu8ifdJdSV5psQxgKv-tjERM7WJ2A",
            authDomain: "jododamemoria.firebaseapp.com",
            projectId: "jododamemoria",
            storageBucket: "jododamemoria.firebasestorage.app",
            messagingSenderId: "628882650020",
            appId: "1:628882650020:web:d38af5fcf33a8894974731",
            measurementId: "G-0M0351L542"
        };
        
        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Vari√°veis Globais ---
        let playerName = '';
        let timerInterval;
        let startTime;
        let seconds = 0;
        let isTimerRunning = false;
        
        const startPage = document.getElementById('start-page');
        const gameContent = document.getElementById('game-content');
        const rankingPage = document.getElementById('ranking-page');
        const nicknameInput = document.getElementById('nicknameInput');
        const startButton = document.getElementById('startButton');
        const playerNicknameSpan = document.getElementById('playerNickname');
        const board = document.querySelector('.board');
        const movesSpan = document.getElementById('moves');
        const matchedPairsSpan = document.getElementById('matched-pairs');
        const timerSpan = document.getElementById('timer');
        const winnerModal = document.getElementById('winnerModal');
        const finalMovesSpan = document.getElementById('finalMoves');
        const finalTimeSpan = document.getElementById('finalTime');
        const finalDateSpan = document.getElementById('finalDate');
        const saveScoreButton = document.getElementById('saveScoreButton');
        const restartButton = document.getElementById('restartButton');
        const adminPage = document.getElementById('admin-page');
        const showAllPlayersButton = document.getElementById('showAllPlayers');
        const showPodiumButton = document.getElementById('showPodiumButton');
        const rebootButton = document.getElementById('rebootButton');
        const adminDataDisplay = document.getElementById('admin-data-display');
        const rankList = document.getElementById('rank-list');
        
        // Elementos de Busca Admin
        const adminSearchInput = document.getElementById('adminSearchInput');
        const adminSearchButton = document.getElementById('adminSearchButton');

        // Novos elementos para o painel do usu√°rio
        const userPanel = document.getElementById('user-panel');
        const consultHistoryButton = document.getElementById('consultHistoryButton');
        const startNewGameButton = document.getElementById('startNewGameButton');
        const viewPodiumButton = document.getElementById('viewPodiumButton'); // NOVO ELEMENTO
        const userHistoryContent = document.getElementById('user-history-content');
        const historyNicknameSpan = document.getElementById('history-nickname');
        const historyList = document.getElementById('history-list');

        // A SENHA DO ADMIN AQUI. TROQUE POR UMA MAIS SEGURA!
        const ADMIN_NICKNAME = "admin123";

        // AQUI EST√Å A MUDAN√áA: as cartas ter√£o um ID √∫nico
        const cardValues = [
            'Cuscuz', 'Bolo de Rolo', 'Canja', 'Pizza', 'Pamonha', 'Canjica',
            'Salada', 'Pastel', 'Cerveja', 'Vinho', 'Chocolate-Quente', 'Frango Assado'
        ];
        
        let gameCards = [];
        let hasFlippedCard = false;
        let lockBoard = false;
        let firstCard, secondCard;
        let moves = 0;
        let matchedPairs = 0;
        let restartCount = 0;

        // --- Fun√ß√µes de L√≥gica do Jogo (N√£o Alteradas) ---
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function createBoard() {
            // Cria um array de objetos para gerenciar as cartas, cada um com um ID e um valor
            gameCards = [...cardValues, ...cardValues].map((value, index) => ({ id: index, value }));
            shuffle(gameCards);

            board.innerHTML = '';
            gameCards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.classList.add('card');
                // A √∫nica informa√ß√£o no DOM √© o ID, que n√£o tem significado para o jogador
                cardElement.dataset.id = index;
                cardElement.innerHTML = `
                    <div class="card-face card-back">?</div>
                    <div class="card-face card-front"></div>
                `;
                cardElement.addEventListener('click', flipCard);
                board.appendChild(cardElement);
            });
        }

        function startTimer() {
            if (isTimerRunning) return;
            isTimerRunning = true;
            startTime = new Date().getTime();
            timerInterval = setInterval(() => {
                const now = new Date().getTime();
                const diff = now - startTime;
                seconds = Math.floor(diff / 1000);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                timerSpan.textContent = `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            isTimerRunning = false;
        }

        function flipCard() {
            if (lockBoard) return;
            if (this === firstCard) return;

            if (!isTimerRunning) {
                startTimer();
            }

            // Pega o valor da carta usando o ID do DOM para buscar na vari√°vel JavaScript segura
            const cardId = this.dataset.id;
            const cardValue = gameCards[cardId].value;

            this.querySelector('.card-front').textContent = cardValue;
            this.classList.add('is-flipped');

            if (!hasFlippedCard) {
                hasFlippedCard = true;
                firstCard = this;
                return;
            }

            secondCard = this;
            moves++;
            movesSpan.textContent = moves;

            checkForMatch();
        }

        function checkForMatch() {
            // Compara os valores das cartas usando a vari√°vel JavaScript, n√£o o DOM
            const isMatch = gameCards[firstCard.dataset.id].value === gameCards[secondCard.dataset.id].value;
            isMatch ? disableCards() : unflipCards();
        }

        function disableCards() {
            firstCard.removeEventListener('click', flipCard);
            secondCard.removeEventListener('click', flipCard);
            
            matchedPairs++;
            matchedPairsSpan.textContent = matchedPairs;

            resetBoard();

            if (matchedPairs === cardValues.length) {
                stopTimer();
                showWinnerModal();
            }
        }

        function unflipCards() {
            lockBoard = true;
            setTimeout(() => {
                firstCard.classList.remove('is-flipped');
                secondCard.classList.remove('is-flipped');
                
                // Limpa o conte√∫do da face da frente ao desvirar
                firstCard.querySelector('.card-front').textContent = '';
                secondCard.querySelector('.card-front').textContent = '';
                
                resetBoard();
            }, 1000);
        }

        function resetBoard() {
            [hasFlippedCard, lockBoard] = [false, false];
            [firstCard, secondCard] = [null, null];
        }

        function showWinnerModal() {
            finalMovesSpan.textContent = moves;
            finalTimeSpan.textContent = timerSpan.textContent;
            finalDateSpan.textContent = new Date().toLocaleString();
            playerNicknameSpan.textContent = playerName;
            winnerModal.style.display = 'flex';
        }
        
        function restartGame() {
            restartCount = 0; // Se o jogo for reiniciado, o contador de restarts deve ser zerado para a nova partida
            stopTimer();
            moves = 0;
            matchedPairs = 0;
            seconds = 0;
            movesSpan.textContent = 0;
            matchedPairsSpan.textContent = "0/12";
            timerSpan.textContent = "00:00";
            createBoard();
        }

        // --- Fun√ß√µes de Navega√ß√£o de Tela ---
        function navigateToRanking() {
            userPanel.style.display = 'none';
            gameContent.style.display = 'none';
            rankingPage.style.display = 'flex';
            adminPage.style.display = 'none';
            // Garante que os scores sejam carregados
            loadScores(); 
        }

        // --- Intera√ß√£o com o Banco de Dados (Firebase) ---
        async function saveScore() {
            try {
                await addDoc(collection(db, "jogadores"), {
                    nome: playerName,
                    pontuacao: moves,
                    tempo: seconds,
                    data: new Date(),
                    reinicios: restartCount
                });
                winnerModal.style.display = 'none';
                navigateToRanking(); // Navega para o ranking ap√≥s salvar
            } catch (e) {
                console.error("Erro ao salvar a pontua√ß√£o: ", e);
                alert("Erro ao salvar a pontua√ß√£o. Verifique a configura√ß√£o do seu Firebase e as regras de seguran√ßa.");
            }
        }

        async function loadScores() {
            const pontuacoesRef = collection(db, "jogadores");
            const q = query(pontuacoesRef, orderBy("tempo"));
            const querySnapshot = await getDocs(q);
            
            rankList.innerHTML = '';
            const scores = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                scores.push(data);
            });

            // Ordena os dados e preenche o p√≥dio visual
            scores.sort((a, b) => a.tempo - b.tempo);
            if (scores.length >= 1) {
                document.getElementById('first-info').textContent = `${scores[0].nome} (${scores[0].tempo}s)`;
            } else {
                document.getElementById('first-info').textContent = "ü•á";
            }
            if (scores.length >= 2) {
                document.getElementById('second-info').textContent = `${scores[1].nome} (${scores[1].tempo}s)`;
            } else {
                document.getElementById('second-info').textContent = "ü•à";
            }
            if (scores.length >= 3) {
                document.getElementById('third-info').textContent = `${scores[2].nome} (${scores[2].tempo}s)`;
            } else {
                document.getElementById('third-info').textContent = "ü•â";
            }

            // Preenche a lista completa
            scores.forEach((data, index) => {
                const li = document.createElement('li');
                const minutes = Math.floor(data.tempo / 60);
                const remainingSeconds = data.tempo % 60;
                const formattedTime = `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
                li.textContent = `${data.nome} - ${formattedTime} (${data.pontuacao} movimentos)`;
                if (index < 3) { // Destaca os 3 primeiros no ranking completo, se quiser
                    li.classList.add('best-score');
                }
                rankList.appendChild(li);
            });
        }
        
        // --- Fun√ß√µes de Admin (N√£o Alteradas) ---

        /**
         * Fun√ß√£o unificada para exibir dados no painel admin.
         * @param {QuerySnapshot} querySnapshot - Resultado da busca no Firebase.
         * @param {string} title - T√≠tulo a ser exibido (ex: "Todos os Registros", "Busca por Nick").
         */
        function displayAdminData(querySnapshot, title) {
            adminDataDisplay.innerHTML = `<h3>${title}</h3>`;
            const ul = document.createElement('ul');

            if (querySnapshot.empty) {
                ul.innerHTML = '<li>Nenhum registro encontrado.</li>';
            } else {
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const li = document.createElement('li');
                    
                    const date = data.data ? data.data.toDate().toLocaleString() : 'N/A';
                    
                    li.innerHTML = `
                        <span>Nick: ${data.nome}, Tempo: ${data.tempo}s, Reinicios: ${data.reinicios}, Data: ${date}</span>
                        <button class="removeUserButton" data-id="${doc.id}">Remover</button>
                    `;
                    ul.appendChild(li);
                });
            }
            
            adminDataDisplay.appendChild(ul);

            // Adiciona evento de clique para os bot√µes de remover
            document.querySelectorAll('.removeUserButton').forEach(button => {
                button.addEventListener('click', (e) => removeUser(e.target.dataset.id));
            });
        }


        async function showAllPlayers() {
            const playersRef = collection(db, "jogadores");
            // Ordena pela data para ver os mais recentes em primeiro (ou por nome)
            const q = query(playersRef, orderBy("data", "desc"));
            const querySnapshot = await getDocs(q);
            displayAdminData(querySnapshot, "Todos os Registros");
        }
        
        // Fun√ß√£o de Busca Admin
        async function searchAdminPlayer() {
            const searchTerm = adminSearchInput.value.trim();
            if (!searchTerm) {
                alert("Por favor, digite um Nickname para buscar.");
                return;
            }

            const playersRef = collection(db, "jogadores");
            // Busca pela correspond√™ncia exata do nome
            const q = query(playersRef, 
                where("nome", "==", searchTerm)
            );
            
            const querySnapshot = await getDocs(q);
            displayAdminData(querySnapshot, `Resultados da Busca por: "${searchTerm}"`);
        }

        async function removeUser(docId) {
            if (!confirm("Tem certeza que deseja remover este usu√°rio?")) {
                return;
            }
            try {
                await deleteDoc(doc(db, "jogadores", docId));
                alert("Usu√°rio removido com sucesso!");
                // Recarrega a √∫ltima exibi√ß√£o (todos, p√≥dio ou busca)
                // Para simplificar, vamos recarregar a lista completa ap√≥s a remo√ß√£o
                showAllPlayers(); 
            } catch (e) {
                console.error("Erro ao remover usu√°rio: ", e);
                alert("Erro ao remover usu√°rio. Tente novamente.");
            }
        }

        async function rebootDatabase() {
            if (!confirm("Voc√™ tem certeza que deseja APAGAR TODO o hist√≥rico de jogadores? Esta a√ß√£o √© irrevers√≠vel!")) {
                return;
            }
            const playersRef = collection(db, "jogadores");
            const querySnapshot = await getDocs(playersRef);
            await runTransaction(db, async (transaction) => {
                querySnapshot.forEach((doc) => {
                    transaction.delete(doc.ref);
                });
            });
            alert("Hist√≥rico de jogadores apagado com sucesso!");
            adminDataDisplay.innerHTML = "";
        }

        // Fun√ß√£o para exibir apenas os 3 melhores tempos (p√≥dio)
        async function showTop3Podium() {
            const playersRef = collection(db, "jogadores");
            // Consulta para pegar os 3 melhores (menor tempo)
            const q = query(playersRef, orderBy("tempo"), limit(3));
            const querySnapshot = await getDocs(q);

            adminDataDisplay.innerHTML = `<h3>üèÜ P√≥dio (Top 3 Melhores Tempos) üèÜ</h3>`;
            const ol = document.createElement('ol');
            let rank = 1;
            
            if (querySnapshot.empty) {
                ol.innerHTML = '<li>Nenhum registro de jogo ainda.</li>';
            } else {
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const li = document.createElement('li');

                    const minutes = Math.floor(data.tempo / 60);
                    const remainingSeconds = data.tempo % 60;
                    const formattedTime = `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
                    
                    let medal = '';
                    if (rank === 1) medal = 'ü•á';
                    else if (rank === 2) medal = 'ü•à';
                    else if (rank === 3) medal = 'ü•â';

                    li.innerHTML = `
                        <span>${medal} <strong>${data.nome}</strong>: ${formattedTime}s (${data.pontuacao} movimentos)</span>
                    `;
                    ol.appendChild(li);
                    rank++;
                });
            }
            
            adminDataDisplay.appendChild(ol);
        }

        // --- Fun√ß√µes para Usu√°rio Cadastrado ---
        async function checkExistingUser() {
            playerName = nicknameInput.value.trim();
            if (playerName.toLowerCase() === ADMIN_NICKNAME) {
                startPage.style.display = 'none';
                gameContent.style.display = 'none';
                rankingPage.style.display = 'none';
                adminPage.style.display = 'block';
                showAllPlayers();
                return;
            }
            
            const playersRef = collection(db, "jogadores");
            const q = query(playersRef, where("nome", "==", playerName));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                // Usu√°rio encontrado, exibe o painel de op√ß√µes
                startPage.style.display = 'none';
                userPanel.style.display = 'flex';
            } else {
                // Usu√°rio n√£o encontrado, inicia o jogo
                startPage.style.display = 'none';
                gameContent.style.display = 'flex';
                restartGame();
            }
        }
        
        async function showUserHistory() {
            historyList.innerHTML = '';
            historyNicknameSpan.textContent = playerName;
            userHistoryContent.style.display = 'block';

            const playersRef = collection(db, "jogadores");
            const q = query(playersRef, where("nome", "==", playerName));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                historyList.innerHTML = '<li>Nenhum hist√≥rico encontrado para este usu√°rio.</li>';
                return;
            }

            let userScores = [];
            querySnapshot.forEach(doc => {
                userScores.push({ id: doc.id, ...doc.data() });
            });
            
            // Encontra o melhor tempo, que √© o menor valor no campo 'tempo'
            let bestScore = userScores.reduce((prev, current) => {
                return (prev.tempo < current.tempo) ? prev : current;
            });
            
            userScores.forEach(score => {
                const li = document.createElement('li');

                const minutes = Math.floor(score.tempo / 60);
                const remainingSeconds = score.tempo % 60;
                const formattedTime = `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
                
                const date = score.data.toDate();
                const formattedDate = date.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                li.textContent = `Tempo: ${formattedTime}s | Movimentos: ${score.pontuacao} | Reinicios: ${score.reinicios} | Data: ${formattedDate}`;
                
                // Adiciona o emoji e a classe se for o melhor tempo
                if (score.id === bestScore.id) {
                    li.classList.add('best-score');
                    li.textContent += " üèÜ";
                }
                
                historyList.appendChild(li);
            });
        }

        function hidePanelsAndStartGame() {
            userPanel.style.display = 'none';
            startPage.style.display = 'none';
            gameContent.style.display = 'flex';
            restartGame();
        }

        // --- Event Listeners ---
        nicknameInput.addEventListener('input', () => {
            startButton.disabled = nicknameInput.value.trim() === '';
        });

        startButton.addEventListener('click', checkExistingUser);
        saveScoreButton.addEventListener('click', saveScore);
        restartButton.addEventListener('click', () => {
            restartGame();
        });
        
        // Eventos do Painel Admin
        showAllPlayersButton.addEventListener('click', showAllPlayers);
        showPodiumButton.addEventListener('click', showTop3Podium);
        rebootButton.addEventListener('click', rebootDatabase);
        
        // Evento para o bot√£o de busca
        adminSearchButton.addEventListener('click', searchAdminPlayer);
        // Opcional: buscar ao pressionar Enter no campo de busca
        adminSearchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                searchAdminPlayer();
            }
        });

        // Eventos do Painel do Usu√°rio
        consultHistoryButton.addEventListener('click', showUserHistory);
        startNewGameButton.addEventListener('click', hidePanelsAndStartGame);
        viewPodiumButton.addEventListener('click', navigateToRanking); // NOVO LISTENER

    </script>
</body>
</html>
