<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jogo da Memória</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #f0f0f0;
      margin: 0;
      padding: 20px;
    }
    h1 { color: #333; text-align: center; }
    .container { width: 100%; max-width: 800px; display: flex; flex-direction: column; align-items: center; }
    #start-page {
      display: flex; flex-direction: column; align-items: center; text-align: center;
      padding: 40px 20px; background-color: #fff; border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    #start-page input {
      padding: 10px; border: 1px solid #ccc; border-radius: 5px;
      margin-right: 10px; font-size: 1em;
    }
    #start-page button {
      padding: 10px 20px; border: none; border-radius: 5px;
      font-size: 1em; cursor: pointer; color: #fff; background-color: #aaa;
    }
    #start-page button:enabled { background-color: #28a745; }
    #existing-player-options { display: none; margin-top: 20px; flex-direction: column; align-items: center; }
    #game-content { display: none; width: 100%; }
    .board { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 10px; width: 100%; max-width: 70%; padding: 10px; background-color: #fff;
      border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .card { width: 100%; aspect-ratio: 1 / 1; position: relative;
      transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer;
    }
    .card.is-flipped { transform: rotateY(180deg); }
    .card .card-face {
      position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
      border-radius: 6px; border: 2px solid #333; box-sizing: border-box;
      font-weight: bold; font-size: 0.9em; display: flex; align-items: center; justify-content: center;
    }
    .card .card-back { background-color: #6a0dad; color: #fff; }
    .card .card-front { background-color: #e6e6fa; transform: rotateY(180deg); color: #333; }
    #player-history { display: none; width: 100%; max-width: 800px; margin-top: 20px;
      background-color: #fff; padding: 20px; border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .history-content { display: flex; justify-content: space-around; flex-wrap: wrap; margin-top: 20px; }
    .last-score, .all-scores {
      flex: 1; padding: 15px; margin: 10px; border: 1px solid #ccc;
      border-radius: 8px; text-align: center;
    }
    .all-scores ul { list-style: none; padding: 0; }
    .all-scores li { margin: 5px 0; padding: 5px; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ATIVIDADE SEMANAL DO RESTAURANTE: JOGO DA MEMÓRIA</h1>

    <!-- Página inicial -->
    <div id="start-page">
      <h2>Bem-vindo(a)!</h2>
      <div>
        <input type="text" id="nicknameInput" placeholder="Digite seu Nickname">
        <button id="startButton" disabled>Começar</button>
      </div>
      <div id="existing-player-options">
        <p>Olá, <strong id="existingPlayerName"></strong>! O que você gostaria de fazer?</p>
        <div>
          <button id="showHistoryButton">Ver Histórico</button>
          <button id="newGameButton">Iniciar Novo Jogo</button>
        </div>
      </div>
    </div>

    <!-- Conteúdo do Jogo -->
    <div id="game-content">
      <div class="game-info">
        <div>Movimentos: <span id="moves">0</span></div>
        <div>Pares Encontrados: <span id="matched-pairs">0</span>/12</div>
        <div>Tempo: <span id="timer">00:00</span></div>
      </div>
      <div class="board"></div>
    </div>

    <!-- Histórico -->
    <div id="player-history">
      <h2>Seu Histórico de Jogos</h2>
      <div class="history-content">
        <div class="last-score">
          <h3>Último Jogo</h3>
          <p>Nick: <span id="lastScoreNick"></span></p>
          <p>Tempo: <span id="lastScoreTime"></span></p>
          <p>Movimentos: <span id="lastScoreMoves"></span></p>
          <p>Data: <span id="lastScoreDate"></span></p>
        </div>
        <div class="all-scores">
          <h3>Todos os Tempos</h3>
          <ul id="history-list"></ul>
        </div>
      </div>
      <button id="backToMainButton" style="margin-top: 20px;">Voltar</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, orderBy, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "SUA_API_KEY",
      authDomain: "SUA_AUTH_DOMAIN",
      projectId: "SEU_PROJECT_ID",
      storageBucket: "SEU_STORAGE_BUCKET",
      messagingSenderId: "SEU_SENDER_ID",
      appId: "SEU_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Variáveis
    let playerName = "";
    let moves = 0;
    let matchedPairs = 0;
    let timerInterval;
    let seconds = 0;

    const startPage = document.getElementById("start-page");
    const gameContent = document.getElementById("game-content");
    const playerHistoryPage = document.getElementById("player-history");
    const nicknameInput = document.getElementById("nicknameInput");
    const startButton = document.getElementById("startButton");
    const existingPlayerOptions = document.getElementById("existing-player-options");
    const existingPlayerNameSpan = document.getElementById("existingPlayerName");
    const showHistoryButton = document.getElementById("showHistoryButton");
    const newGameButton = document.getElementById("newGameButton");
    const backToMainButton = document.getElementById("backToMainButton");
    const lastScoreNickSpan = document.getElementById("lastScoreNick");
    const lastScoreTimeSpan = document.getElementById("lastScoreTime");
    const lastScoreMovesSpan = document.getElementById("lastScoreMoves");
    const lastScoreDateSpan = document.getElementById("lastScoreDate");
    const historyListUl = document.getElementById("history-list");

    // --- Funções Firebase
    async function checkPlayerHistory(nick) {
      const playersRef = collection(db, "jogadores");
      const q = query(playersRef, where("nome", "==", nick), orderBy("data", "desc"));
      const querySnapshot = await getDocs(q);

      const history = [];
      querySnapshot.forEach(doc => history.push(doc.data()));
      return history;
    }

    async function saveGameResult(nick, tempo, movimentos) {
      try {
        await addDoc(collection(db, "jogadores"), {
          nome: nick,
          tempo: tempo,
          pontuacao: movimentos,
          data: serverTimestamp()
        });
        console.log("Resultado salvo com sucesso!");
      } catch (e) {
        console.error("Erro ao salvar resultado: ", e);
      }
    }

    async function showPlayerHistory(history) {
      startPage.style.display = "none";
      playerHistoryPage.style.display = "block";

      const lastScore = history[0];
      lastScoreNickSpan.textContent = lastScore.nome;
      lastScoreTimeSpan.textContent = `${Math.floor(lastScore.tempo/60)}m ${lastScore.tempo%60}s`;
      lastScoreMovesSpan.textContent = lastScore.pontuacao;
      lastScoreDateSpan.textContent = lastScore.data.toDate().toLocaleString();

      historyListUl.innerHTML = "";
      history.forEach(score => {
        const li = document.createElement("li");
        const minutes = Math.floor(score.tempo / 60);
        const seconds = score.tempo % 60;
        li.textContent = `${minutes}m ${seconds}s (${score.pontuacao} movimentos) - ${score.data.toDate().toLocaleString()}`;
        historyListUl.appendChild(li);
      });
    }

    function startGame() {
      startPage.style.display = "none";
      playerHistoryPage.style.display = "none";
      gameContent.style.display = "block";
      console.log("Iniciando jogo para:", playerName);

      moves = 0;
      matchedPairs = 0;
      seconds = 0;
      document.getElementById("moves").textContent = moves;
      document.getElementById("matched-pairs").textContent = matchedPairs;
      document.getElementById("timer").textContent = "00:00";

      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        seconds++;
        let min = String(Math.floor(seconds / 60)).padStart(2, "0");
        let sec = String(seconds % 60).padStart(2, "0");
        document.getElementById("timer").textContent = `${min}:${sec}`;
      }, 1000);
    }

    function endGame() {
      clearInterval(timerInterval);
      saveGameResult(playerName, seconds, moves);
      alert(`Parabéns, ${playerName}! Você concluiu o jogo em ${seconds}s com ${moves} movimentos.`);
      gameContent.style.display = "none";
      startPage.style.display = "flex";
      nicknameInput.value = "";
      existingPlayerOptions.style.display = "none";
    }

    // --- Eventos
    nicknameInput.addEventListener("input", () => {
      startButton.disabled = nicknameInput.value.trim() === "";
    });

    startButton.addEventListener("click", async () => {
      playerName = nicknameInput.value.trim();
      const history = await checkPlayerHistory(playerName);

      if (history.length > 0) {
        existingPlayerNameSpan.textContent = playerName;
        existingPlayerOptions.style.display = "flex";
      } else {
        startGame();
      }
    });

    showHistoryButton.addEventListener("click", async () => {
      const history = await checkPlayerHistory(playerName);
      if (history.length > 0) showPlayerHistory(history);
    });

    newGameButton.addEventListener("click", startGame);

    backToMainButton.addEventListener("click", () => {
      playerHistoryPage.style.display = "none";
      startPage.style.display = "flex";
      existingPlayerOptions.style.display = "none";
      nicknameInput.value = "";
    });

    // ⚠️ Exemplo de simulação de fim de jogo (apaga depois de conectar com a lógica real do jogo)
    // Aqui você chamaria `endGame()` quando todos os pares forem encontrados
    window.simularFim = () => { endGame(); };
  </script>
</body>
</html>
